<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Chat Département</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Styles CSS inchangés pour le moment, le CSS pour les nouvelles fonctionnalités sera ajouté plus tard */
        /* ... (Gardez tous vos styles existants) ... */

        /* Nouveaux styles pour le mode nuit */
        body.dark-mode {
            --primary: #04978c;
            --secondary: #00796B;
            --light: #37464F;
            --bg: #111B21;
            --white: #1F2C34;
            --gray: #2A3942;
            color: #E9EDEF;
        }

        body.dark-mode #rooms h3 {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-mode #rooms button:hover {
            background: #00695C;
        }

        body.dark-mode #sidebar {
            border-left: 1px solid #444;
        }

        body.dark-mode .other {
            background: var(--gray);
            color: white;
        }

        body.dark-mode .me {
            background: #005C4B;
            color: white;
        }

        body.dark-mode #form {
            background: var(--white);
            border-top: 1px solid #444;
        }

        body.dark-mode #messageInput {
            background: var(--white);
            color: #E9EDEF;
        }

        /* Nouveaux styles pour le bouton du mode nuit */
        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
        }
        
        /* Styles pour l'envoi de fichiers */
        #form button.file-upload {
            padding: 15px;
            background: #128C7E;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        #form button.file-upload:hover {
            background: #075E54;
        }

        .file-message {
            max-width: 50%;
        }

        .file-message img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 5px;
        }

        .file-message a {
            color: var(--primary);
            text-decoration: none;
            word-break: break-all;
        }
    </style>
</head>

<body>
    <button id="theme-toggle" class="theme-toggle">🌙</button>
    <div id="container">
        <div id="main">
            <div id="header">Bienvenue 👋</div>
            <div id="chat-box"></div>
            <div id="form">
                <input type="file" id="fileInput" accept="image/*, .pdf" style="display: none;">
                <button class="file-upload" onclick="document.getElementById('fileInput').click()">📎</button>

                <input id="messageInput" autocomplete="off" placeholder="Écris ton message..." />
                <button class="send">Envoyer</button>
            </div>
        </div>
        
        <div id="sidebar">
            <h3>En ligne</h3>
            <ul id="userList"></ul>
        </div>
    </div>
    
    <div id="login">
        </div>
    
    <script>
       const socket = io();
let username = "";
let currentRoom = "";

// 1. Gestion du mode nuit/jour
const themeToggle = document.getElementById("theme-toggle");
themeToggle.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    const isDarkMode = document.body.classList.contains("dark-mode");
    themeToggle.textContent = isDarkMode ? "☀️" : "🌙";
    localStorage.setItem("theme", isDarkMode ? "dark" : "light");
});

// Charger la préférence de l'utilisateur
if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    themeToggle.textContent = "☀️";
}

// 2. Fonctions existantes
function setUsername() {
    username = document.getElementById("username").value.trim();
    if (username) {
        document.getElementById("login").style.display = "none";
    }
}

function joinRoom(room) {
    if (!username) {
        alert("Entrez d'abord un pseudo !");
        return;
    }
    currentRoom = room;
    document.getElementById("header").textContent = "Salon : " + room;
    document.getElementById("chat-box").innerHTML = "";
    socket.emit("joinRoom", { username, room });
}

// 3. Gestion de l'envoi de messages et de fichiers
const messageInput = document.getElementById("messageInput");
const sendButton = document.querySelector("#form .send");
const fileInput = document.getElementById("fileInput");
const chatBox = document.getElementById("chat-box");

function sendMessage() {
    const msg = messageInput.value.trim();
    if (msg && currentRoom) {
        socket.emit("message", { user: username, text: msg, room: currentRoom });
        messageInput.value = "";
    }
}

// Gérer l'envoi avec la touche Entrée
messageInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        sendMessage();
    }
});
sendButton.addEventListener("click", sendMessage);


fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file && currentRoom) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const fileData = event.target.result;
            const fileName = file.name;
            const fileType = file.type;

            socket.emit("file-upload", {
                user: username,
                room: currentRoom,
                fileName: fileName,
                fileData: fileData,
                fileType: fileType
            });
        };
        reader.readAsDataURL(file);
    }
});

// 4. Réception des messages et fichiers
socket.on("message", (data) => {
    const div = document.createElement("div");
    div.className = `message ${data.user === username ? "me" : "other"}`;

    if (data.fileType) {
        // C'est un fichier
        if (data.fileType.startsWith("image/")) {
            div.innerHTML = `
                <div class="file-message">
                    <strong>${data.user}</strong>: <br>
                    <img src="${data.fileData}" alt="${data.fileName}">
                    <span class="time">${data.time}</span>
                </div>
            `;
        } else if (data.fileType === "application/pdf") {
            div.innerHTML = `
                <div class="file-message">
                    <strong>${data.user}</strong>: <br>
                    <a href="${data.fileData}" download="${data.fileName}">
                        <img src="https://img.icons8.com/color/48/000000/pdf.png" alt="PDF icon" style="width: 30px;">
                        ${data.fileName}
                    </a>
                    <span class="time">${data.time}</span>
                </div>
            `;
        }
    } else {
        // C'est un message texte
        div.innerHTML = `<strong>${data.user}</strong>: ${data.text} <span class="time">${data.time}</span>`;
    }

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
});


socket.on("notification", (msg) => {
    const div = document.createElement("div");
    div.className = "notification";
    div.textContent = msg;
    chatBox.appendChild(div);
});

socket.on("userList", (users) => {
    const ul = document.getElementById("userList");
    ul.innerHTML = "";
    users.forEach(user => {
        const li = document.createElement("li");
        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = user.charAt(0).toUpperCase();
        li.appendChild(avatar);
        li.appendChild(document.createTextNode(user));
        ul.appendChild(li);
    });
});
    </script>
</body>
</html>
